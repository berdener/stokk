{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4>Müşteriler</h4>
  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#customerModal">
    <i class="bi bi-person-plus me-1"></i>Yeni Müşteri
  </button>
</div>

<div class="card shadow-sm border-0">
  <div class="card-body">
    <table class="table table-striped align-middle" id="tbl">
      <thead>
        <tr>
          <th>Ad Soyad</th><th>Telefon</th><th>E-posta</th><th>Borç (₺)</th>
        </tr>
      </thead>
      <tbody id="customer-rows">
        {% for c in customers %}
        <tr>
          <td>{{ c.name }}</td>
          <td>{{ c.phone or "-" }}</td>
          <td>{{ c.email or "-" }}</td>
          <td>{{ '%.2f'|format(c.debt or 0) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="customerModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-person-plus me-1"></i>Yeni Müşteri</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="customerForm" class="row g-3">
          <div class="col-12">
            <label class="form-label">Ad Soyad *</label>
            <input class="form-control" name="name" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Telefon</label>
            <input class="form-control" name="phone">
          </div>
          <div class="col-md-6">
            <label class="form-label">E-posta</label>
            <input class="form-control" name="email" type="email">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button id="btnSaveCustomer" class="btn btn-success">
          <i class="bi bi-check2-circle me-1"></i>Kaydet
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  $(function(){ if ($.fn.DataTable) $('#tbl').DataTable(); });

  document.getElementById('btnSaveCustomer')?.addEventListener('click', async () => {
    const form = document.getElementById('customerForm');
    const data = Object.fromEntries(new FormData(form).entries());

    try {
      const res = await fetch("/api/customers", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(data)
      });
      const out = await res.json();

      if (!res.ok || !out.ok) {
        alert(out.message || "Kayıt hatası");
        return;
      }
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${out.customer.name}</td>
        <td>${out.customer.phone}</td>
        <td>${out.customer.email}</td>
        <td>${out.customer.debt}</td>`;
      document.getElementById('customer-rows').prepend(tr);

      form.reset();
      const modal = bootstrap.Modal.getInstance(document.getElementById('customerModal'));
      modal.hide();
    } catch (e) {
      console.error(e);
      alert("Bağlantı hatası.");
    }
  });
</script>
{% endblock %}
